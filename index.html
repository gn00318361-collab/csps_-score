<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>114å­¸å¹´åº¦è¦ªè·æ•™è‚²æ—¥ åœ’éŠæœƒè©•åˆ†</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif;background:#f0f2f5;color:#333;min-height:100vh;padding-bottom:90px}

  .header{color:#fff;padding:18px 16px 14px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
  .header.teacher-mode{background:linear-gradient(135deg,#4a90d9,#357abd)}
  .header.admin-mode{background:linear-gradient(135deg,#e67e22,#d35400)}
  .header h1{font-size:17px;font-weight:700}
  .header .sub{font-size:12px;opacity:.85;margin-top:2px}

  .container{max-width:560px;margin:0 auto;padding:14px}

  .screen{display:none}
  .screen.active{display:block}
  .role-screen.active{display:flex;flex-direction:column;align-items:center;padding-top:30px}

  .role-icon{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;color:#fff;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
  .role-title{font-size:20px;font-weight:700;margin-bottom:6px}
  .role-desc{font-size:13px;color:#888;margin-bottom:24px;text-align:center;line-height:1.5}

  .role-cards{display:flex;gap:12px;width:100%}
  .role-card{flex:1;background:#fff;border:2px solid #ddd;border-radius:14px;padding:20px 12px;text-align:center;cursor:pointer;transition:all .2s}
  .role-card:active{transform:scale(.97)}
  .role-card .rc-icon{font-size:36px;margin-bottom:10px}
  .role-card .rc-title{font-size:16px;font-weight:700;margin-bottom:4px}
  .role-card .rc-desc{font-size:12px;color:#888;line-height:1.4}

  .field-label{display:block;font-size:13px;font-weight:700;color:#555;margin-bottom:8px;width:100%}
  .info-bar{background:#fff8e1;border-left:4px solid #f9a825;padding:10px 12px;border-radius:0 8px 8px 0;font-size:12px;color:#666;margin-bottom:14px;line-height:1.5}
  .info-bar strong{color:#333}

  .big-btn{width:100%;padding:15px;border:none;border-radius:12px;color:#fff;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:opacity .2s;margin-top:4px}
  .big-btn:disabled{opacity:.35;cursor:not-allowed}
  .big-btn.blue{background:linear-gradient(135deg,#4a90d9,#357abd)}

  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;margin-bottom:18px}
  .g-btn{padding:12px 6px;border:2px solid #ddd;border-radius:10px;background:#fff;font-size:15px;font-weight:600;color:#555;cursor:pointer;text-align:center;transition:all .15s}
  .g-btn.on{border-color:#4a90d9;background:#e8f0fe;color:#4a90d9}

  .t-btn{display:block;width:100%;padding:13px 16px;margin-bottom:7px;border:2px solid #ddd;border-radius:10px;background:#fff;font-size:15px;color:#555;cursor:pointer;text-align:left;transition:all .15s}
  .t-btn.on{border-color:#4a90d9;background:#e8f0fe;color:#4a90d9;font-weight:700}

  .count-row{display:flex;align-items:center;gap:12px;margin-bottom:18px}
  .count-row label{font-size:13px;font-weight:600;color:#555}
  .cnt-btn{width:36px;height:36px;border-radius:50%;border:2px solid #4a90d9;background:#fff;font-size:18px;font-weight:700;color:#4a90d9;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .cnt-val{font-size:22px;font-weight:700;color:#4a90d9;min-width:32px;text-align:center}

  .class-tabs{display:flex;overflow-x:auto;gap:6px;padding:4px 0 12px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .class-tabs::-webkit-scrollbar{display:none}
  .tab{flex-shrink:0;padding:8px 16px;border-radius:20px;border:2px solid #ddd;background:#fff;font-size:14px;font-weight:600;color:#888;cursor:pointer;transition:all .15s;position:relative}
  .tab.on{border-color:#4a90d9;background:#4a90d9;color:#fff}
  .tab.done::after{content:'âœ“';position:absolute;top:-4px;right:-4px;width:18px;height:18px;background:#27ae60;border-radius:50%;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:center}

  .score-card{background:#fff;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,.05)}
  .score-card h3{font-size:16px;margin-bottom:14px;color:#333}

  .row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0}
  .row:last-child{border-bottom:none}
  .row-label{font-size:14px;font-weight:600;color:#444;flex-shrink:0;width:76px}
  .star-group{display:flex;gap:3px}
  .star{width:30px;height:30px;border-radius:8px;border:1.5px solid #ddd;background:#fff;font-size:13px;font-weight:700;color:#aaa;cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center}
  .star.on{border-color:#4a90d9;background:#4a90d9;color:#fff}
  .row-score{min-width:32px;text-align:right;font-size:18px;font-weight:700;color:#e67e22}

  .total-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0 0;border-top:2px dashed #eee;margin-top:6px}
  .total-label{font-size:15px;font-weight:700;color:#555}
  .total-val{font-size:22px;font-weight:800;color:#e67e22}

  .progress-text{text-align:center;font-size:13px;color:#999;margin-bottom:12px}

  .bottom-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:10px 16px;box-shadow:0 -2px 8px rgba(0,0,0,.08);display:flex;gap:10px;z-index:90;max-width:560px;margin:0 auto}
  .b-btn{flex:1;padding:13px;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer}
  .b-btn.sec{background:#f0f0f0;color:#666}
  .b-btn.pri{background:linear-gradient(135deg,#27ae60,#219a52);color:#fff;box-shadow:0 3px 10px rgba(39,174,96,.25)}
  .b-btn.pri:disabled{opacity:.35}

  .result-top{text-align:center;margin-bottom:16px}
  .result-top .chk{width:56px;height:56px;background:#27ae60;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:28px;color:#fff}

  .res-card{background:#fff;border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,.05);overflow-x:auto}
  .res-table{width:100%;border-collapse:collapse;font-size:13px;white-space:nowrap}
  .res-table th{background:#f5f7fa;padding:8px 6px;text-align:center;font-weight:700;color:#555;border-bottom:2px solid #ddd}
  .res-table td{padding:8px 6px;text-align:center;border-bottom:1px solid #eee}
  .highlight{font-weight:700;color:#e67e22}
  .rank-1{color:#e74c3c;font-weight:700}
  .rank-2{color:#e67e22;font-weight:700}
  .rank-3{color:#2ecc71;font-weight:700}

  .act-btns{display:flex;flex-direction:column;gap:8px;margin-top:14px}
  .act-btn{padding:13px;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;text-align:center}
  .act-btn.copy{background:#4a90d9;color:#fff}
  .act-btn.line{background:#06C755;color:#fff}
  .act-btn.reset{background:#f0f0f0;color:#666}
  .act-btn.orange{background:#e67e22;color:#fff}

  .admin-grade-bar{display:flex;gap:6px;overflow-x:auto;padding:4px 0 14px;scrollbar-width:none}
  .admin-grade-bar::-webkit-scrollbar{display:none}
  .ag-btn{flex-shrink:0;padding:10px 18px;border-radius:20px;border:2px solid #ddd;background:#fff;font-size:14px;font-weight:600;color:#888;cursor:pointer;transition:all .15s}
  .ag-btn.on{border-color:#e67e22;background:#e67e22;color:#fff}

  .teacher-tabs{display:flex;gap:6px;overflow-x:auto;padding:4px 0 12px;scrollbar-width:none}
  .teacher-tabs::-webkit-scrollbar{display:none}
  .tt{flex-shrink:0;padding:8px 14px;border-radius:18px;border:2px solid #ddd;background:#fff;font-size:13px;font-weight:600;color:#888;cursor:pointer;transition:all .15s;position:relative}
  .tt.on{border-color:#e67e22;background:#fef5ed;color:#e67e22}
  .tt.done::after{content:'âœ“';position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:#27ae60;border-radius:50%;font-size:10px;color:#fff;display:flex;align-items:center;justify-content:center}

  .input-table{width:100%;border-collapse:collapse;font-size:13px}
  .input-table th{background:#f5f7fa;padding:8px 4px;text-align:center;font-weight:700;color:#555;border-bottom:2px solid #ddd}
  .input-table td{padding:6px 2px;text-align:center;border-bottom:1px solid #eee}
  .cls-label{font-weight:700;color:#444;text-align:left;padding-left:8px}

  .score-input{width:40px;height:34px;border:1.5px solid #ddd;border-radius:8px;text-align:center;font-size:14px;font-weight:600;color:#333;outline:none;transition:border-color .15s}
  .score-input:focus{border-color:#e67e22}
  .score-input.filled{background:#fef5ed;border-color:#e67e22}
  .row-total-admin{font-weight:700;color:#e67e22;font-size:14px}

  .stats-section{margin-top:18px}
  .stats-title{font-size:16px;font-weight:700;color:#333;margin-bottom:12px}

  .submit-time{font-size:12px;color:#27ae60;background:#eafaf1;padding:6px 10px;border-radius:8px;margin-bottom:10px;border-left:3px solid #27ae60}

  .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:8px 22px;border-radius:18px;font-size:13px;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none}
  .toast.show{opacity:1}
</style>
</head>
<body>

<div class="header teacher-mode" id="mainHeader">
  <h1>114å­¸å¹´åº¦è¦ªè·æ•™è‚²æ—¥</h1>
  <div class="sub">åœ’éŠæœƒæ”¤ä½è©•åˆ†ç³»çµ±</div>
</div>

<div class="container">

  <!-- è§’è‰²é¸æ“‡ -->
  <div class="screen role-screen active" id="scrRole">
    <div class="role-icon" style="background:linear-gradient(135deg,#4a90d9,#e67e22)">ğŸ“‹</div>
    <div class="role-title">è«‹é¸æ“‡èº«ä»½</div>
    <div class="role-desc">è©•åˆ†è€å¸«ç›´æ¥æ‰“åˆ†æ•¸<br>ç®¡ç†è€…æŸ¥çœ‹çµ±è¨ˆçµæœ</div>
    <div class="role-cards">
      <div class="role-card" onclick="pickRole('teacher')">
        <div class="rc-icon">âœï¸</div>
        <div class="rc-title">è©•åˆ†è€å¸«</div>
        <div class="rc-desc">å„ç­æ”¤ä½è©•åˆ†<br>è©•å®Œç›´æ¥é€å‡º</div>
      </div>
      <div class="role-card" onclick="pickRole('admin')">
        <div class="rc-icon">ğŸ“Š</div>
        <div class="rc-title">ç®¡ç†è€…</div>
        <div class="rc-desc">è¼¸å…¥/æŸ¥çœ‹åˆ†æ•¸<br>çµ±è¨ˆåæ¬¡çµæœ</div>
      </div>
    </div>
  </div>

  <!-- è€å¸«ç™»å…¥ -->
  <div class="screen" id="scrTeacherLogin" style="padding-top:20px">
    <span class="field-label">é¸æ“‡è©•åˆ†å¹´ç´š</span>
    <div class="grid3" id="tGradeGrid"></div>
    <div id="tTeacherWrap" style="display:none">
      <span class="field-label">é¸æ“‡æ‚¨çš„å§“å</span>
      <div id="tTeacherList"></div>
    </div>
    <div class="count-row" id="tCountRow" style="display:none">
      <label>ç­ç´šæ•¸ï¼š</label>
      <button class="cnt-btn" onclick="tAdjCount(-1)">âˆ’</button>
      <span class="cnt-val" id="tCntVal">10</span>
      <button class="cnt-btn" onclick="tAdjCount(1)">+</button>
    </div>
    <button class="big-btn blue" id="tStartBtn" disabled onclick="tStartScoring()">é–‹å§‹è©•åˆ†</button>
  </div>

  <!-- è€å¸«è©•åˆ† -->
  <div class="screen" id="scrTeacherScore">
    <div class="info-bar" id="tInfoBar"></div>
    <div class="progress-text" id="tProgress"></div>
    <div class="class-tabs" id="tClassTabs"></div>
    <div id="tScoreArea"></div>
    <div class="bottom-bar">
      <button class="b-btn sec" onclick="tGoBack()">è¿”å›</button>
      <button class="b-btn pri" id="tSubmitBtn" onclick="tSubmit()">âœ“ æäº¤è©•åˆ†</button>
    </div>
  </div>

  <!-- è€å¸«çµæœ -->
  <div class="screen" id="scrTeacherResult">
    <div class="result-top">
      <div class="chk">âœ“</div>
      <div class="role-title">è©•åˆ†å®Œæˆï¼</div>
      <div class="role-desc" id="tResSub"></div>
    </div>
    <div class="res-card">
      <table class="res-table" id="tResTable"></table>
    </div>
    <div class="act-btns">
      <button class="act-btn copy" onclick="tCopyRes()">ğŸ“‹ è¤‡è£½è©•åˆ†çµæœ</button>
      <button class="act-btn line" onclick="tShareLine()">ğŸ’¬ LINE å‚³é€çµ¦ç®¡ç†è€…</button>
      <div style="text-align:center;font-size:12px;color:#999;margin-top:4px">ç®¡ç†è€… LINE IDï¼šwanbadan3310</div>
      <button class="act-btn reset" onclick="goHome()">ğŸ  å›é¦–é </button>
    </div>
  </div>

  <!-- ç®¡ç†è€… -->
  <div class="screen" id="scrAdmin">
    <div class="admin-grade-bar" id="aGradeBar"></div>
    <div class="count-row">
      <label>ç­ç´šæ•¸ï¼š</label>
      <button class="cnt-btn" style="border-color:#e67e22;color:#e67e22" onclick="aAdjCount(-1)">âˆ’</button>
      <span class="cnt-val" id="aCntVal" style="color:#e67e22">10</span>
      <button class="cnt-btn" style="border-color:#e67e22;color:#e67e22" onclick="aAdjCount(1)">+</button>
    </div>
    <div class="info-bar">åˆ‡æ›å„è©•åˆ†è€å¸«åˆ†é è¼¸å…¥åˆ†æ•¸ï¼Œç³»çµ±è‡ªå‹•è¨ˆç®—å¹³å‡èˆ‡åæ¬¡ã€‚<br>è€å¸«æäº¤çš„è©•åˆ†ä¹Ÿæœƒè‡ªå‹•å‡ºç¾åœ¨é€™è£¡ã€‚</div>
    <div class="teacher-tabs" id="aTeacherTabs"></div>
    <div id="aInputArea"></div>

    <div class="stats-section" id="aStatsSection" style="display:none">
      <div class="stats-title">ğŸ“Š çµ±è¨ˆçµæœ</div>
      <div class="res-card">
        <table class="res-table" id="aStatsTable"></table>
      </div>
      <div class="act-btns">
        <button class="act-btn orange" onclick="aCopyStats()">ğŸ“‹ è¤‡è£½çµ±è¨ˆçµæœ</button>
        <button class="act-btn line" onclick="aShareLine()">ğŸ’¬ LINE å‚³é€</button>
        <button class="act-btn copy" onclick="aExportAll()">ğŸ“Š åŒ¯å‡ºå…¨å¹´ç´š</button>
        <button class="act-btn reset" onclick="goHome()">ğŸ  å›é¦–é </button>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const TEACHERS={
  "ä¸€å¹´ç´š":["å»ºèƒ½ä¸»ä»»","ç‰èŠ³è€å¸«","å©•å«£è€å¸«"],
  "äºŒå¹´ç´š":["ç¹¼æ´‹è€å¸«","å®£å‹»è€å¸«","æ”¿è¼è€å¸«"],
  "ä¸‰å¹´ç´š":["ç‰é›ªä¸»ä»»","è©©åšè€å¸«","ç§€é›¯è€å¸«","è‚²éœ–è€å¸«"],
  "å››å¹´ç´š":["å‰ç”„è€å¸«","ç›ŠèªŒè€å¸«","å˜‰çªè€å¸«","äººéˆœè€å¸«"],
  "äº”å¹´ç´š":["ç©è–‡è€å¸«","å½¥å©·è€å¸«","ä½©å€«è€å¸«","å¿ƒç›ˆè€å¸«"],
  "å…­å¹´ç´š":["ä¸€æ™ºè€å¸«","æ–‡ç“Šè€å¸«","ä½³çªè€å¸«","æ¹˜æ¥¨è€å¸«"]
};
const CRITERIA=[
  {key:"dec",name:"æ”¤ä½ä½ˆç½®"},{key:"tidy",name:"å ´åœ°æ•´æ½”"},
  {key:"manner",name:"å­¸ç”Ÿç¦®ç¯€"},{key:"spirit",name:"åœ˜éšŠç²¾ç¥"},
  {key:"other",name:"å…¶ä»–è¡¨ç¾"}
];
const MAX=10,GRADES=Object.keys(TEACHERS);

let role=null;
let aCurGrade=GRADES[0],aCurTeacher=0;
let aClassCounts={},aData={},aTimestamps={};
let tGrade=null,tTeacher=null,tClassCount=10,tCurClass=0;
let tScores=[];

GRADES.forEach(g=>{aClassCounts[g]=10;aData[g]={};aTimestamps[g]={};TEACHERS[g].forEach(t=>{aData[g][t]=null;aTimestamps[g][t]=null;});});

function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function setHeader(mode){const h=document.getElementById('mainHeader');h.className='header '+(mode==='admin'?'admin-mode':'teacher-mode');h.querySelector('.sub').textContent=mode==='admin'?'è©•åˆ†çµ±è¨ˆç³»çµ±ï¼ˆç®¡ç†è€…ï¼‰':'åœ’éŠæœƒæ”¤ä½è©•åˆ†ç³»çµ±';}
function pickRole(r){role=r;if(r==='teacher'){setHeader('teacher');initTeacherLogin();show('scrTeacherLogin');}else{setHeader('admin');initAdmin();show('scrAdmin');}}
function goHome(){setHeader('teacher');show('scrRole');}

// ===== è€å¸«ç™»å…¥ =====
function initTeacherLogin(){
  const grid=document.getElementById('tGradeGrid');grid.innerHTML='';
  tGrade=null;tTeacher=null;tClassCount=10;
  document.getElementById('tStartBtn').disabled=true;
  document.getElementById('tTeacherWrap').style.display='none';
  document.getElementById('tCountRow').style.display='none';
  GRADES.forEach(g=>{const b=document.createElement('button');b.className='g-btn';b.textContent=g;b.onclick=()=>tPickGrade(g);grid.appendChild(b);});
}
function tPickGrade(g){
  tGrade=g;tTeacher=null;document.getElementById('tStartBtn').disabled=true;
  document.querySelectorAll('#tGradeGrid .g-btn').forEach(b=>b.classList.toggle('on',b.textContent===g));
  document.getElementById('tTeacherWrap').style.display='block';
  const list=document.getElementById('tTeacherList');list.innerHTML='';
  TEACHERS[g].forEach(t=>{const b=document.createElement('button');b.className='t-btn';b.textContent=t;b.onclick=()=>{tTeacher=t;document.querySelectorAll('#tTeacherList .t-btn').forEach(x=>x.classList.remove('on'));b.classList.add('on');document.getElementById('tStartBtn').disabled=false;};list.appendChild(b);});
  document.getElementById('tCountRow').style.display='flex';tClassCount=aClassCounts[g]||10;document.getElementById('tCntVal').textContent=tClassCount;
}
function tAdjCount(d){tClassCount=Math.max(1,Math.min(15,tClassCount+d));document.getElementById('tCntVal').textContent=tClassCount;}

// ===== è€å¸«è©•åˆ† =====
function tStartScoring(){
  if(!tGrade||!tTeacher)return;
  tScores=[];for(let i=0;i<tClassCount;i++){const o={};CRITERIA.forEach(c=>o[c.key]=0);tScores.push(o);}
  tCurClass=0;show('scrTeacherScore');
  document.getElementById('tInfoBar').innerHTML=`<strong>${tTeacher}</strong>ï½œ${tGrade}ï¼ˆ${tClassCount} ç­ï¼‰<br>é»é¸æ•¸å­—å³å¯çµ¦åˆ†ï¼Œè©•å®Œè‡ªå‹•è·³ä¸‹ä¸€ç­`;
  tRenderTabs();tRenderCard();
}
function tRenderTabs(){
  const w=document.getElementById('tClassTabs');w.innerHTML='';
  for(let i=0;i<tClassCount;i++){const t=document.createElement('button');t.className='tab'+(i===tCurClass?' on':'');t.textContent=`${i+1}ç­`;if(tDone(i)&&i!==tCurClass)t.classList.add('done');t.onclick=()=>{tCurClass=i;tRenderTabs();tRenderCard();};w.appendChild(t);}
  const a=w.querySelector('.tab.on');if(a)a.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  const done=tScores.filter((_,i)=>tDone(i)).length;
  document.getElementById('tProgress').textContent=`å·²å®Œæˆ ${done}/${tClassCount} ç­`;
  document.getElementById('tSubmitBtn').disabled=done<tClassCount;
}
function tDone(i){return CRITERIA.every(c=>tScores[i][c.key]>0);}
function tRenderCard(){
  const s=tScores[tCurClass];
  let h=`<div class="score-card"><h3>${tGrade} ${tCurClass+1}ç­</h3>`;
  CRITERIA.forEach(c=>{h+=`<div class="row"><span class="row-label">${c.name}</span><div class="star-group">`;for(let n=1;n<=MAX;n++)h+=`<button class="star${s[c.key]>=n?' on':''}" onclick="tSet('${c.key}',${n})">${n}</button>`;h+=`</div><span class="row-score">${s[c.key]||'-'}</span></div>`;});
  const total=CRITERIA.reduce((sum,c)=>sum+s[c.key],0);
  h+=`<div class="total-row"><span class="total-label">ç¸½åˆ†</span><span class="total-val">${total||'-'}</span></div></div>`;
  document.getElementById('tScoreArea').innerHTML=h;
}
function tSet(key,val){
  tScores[tCurClass][key]=val;tRenderCard();tRenderTabs();
  if(tDone(tCurClass)&&tCurClass<tClassCount-1){setTimeout(()=>{for(let i=tCurClass+1;i<tClassCount;i++){if(!tDone(i)){tCurClass=i;tRenderTabs();tRenderCard();showToast(`è·³åˆ° ${i+1}ç­`);return;}}},350);}
}
function tGoBack(){if(tScores.some((_,i)=>tDone(i))&&!confirm('è¿”å›å°‡æ¸…é™¤è©•åˆ†ï¼Œç¢ºå®šå—ï¼Ÿ'))return;show('scrTeacherLogin');}

// ===== è€å¸«æäº¤ =====
function tSubmit(){
  const u=tScores.findIndex((_,i)=>!tDone(i));
  if(u>=0){showToast(`${u+1}ç­ å°šæœ‰æœªè©•é …ç›®`);tCurClass=u;tRenderTabs();tRenderCard();return;}
  aClassCounts[tGrade]=tClassCount;if(!aData[tGrade])aData[tGrade]={};
  aData[tGrade][tTeacher]=JSON.parse(JSON.stringify(tScores));aTimestamps[tGrade][tTeacher]=new Date().toLocaleString('zh-TW');saveLS();
  show('scrTeacherResult');document.getElementById('tResSub').innerHTML=`${tTeacher}ï½œ${tGrade}<br><span style="font-size:12px;color:#e67e22">è«‹å°‡çµæœå‚³é€çµ¦ç®¡ç†è€… LINE: wanbadan3310</span>`;tRenderResult();
}
function tRenderResult(){
  const tots=tScores.map((s,i)=>({cls:i+1,s,total:CRITERIA.reduce((sum,c)=>sum+s[c.key],0)}));
  tots.sort((a,b)=>b.total-a.total);let r=1;tots.forEach((it,i)=>{if(i>0&&it.total<tots[i-1].total)r=i+1;it.rank=r;});
  const d=[...tots].sort((a,b)=>a.cls-b.cls);
  let h=`<tr><th>ç­ç´š</th>`;CRITERIA.forEach(c=>h+=`<th>${c.name}</th>`);h+=`<th>ç¸½åˆ†</th><th>åæ¬¡</th></tr>`;
  d.forEach(x=>{const rc=x.rank<=3?` rank-${x.rank}`:'';h+=`<tr><td><strong>${x.cls}ç­</strong></td>`;CRITERIA.forEach(c=>h+=`<td>${x.s[c.key]}</td>`);h+=`<td class="highlight">${x.total}</td><td class="${rc}">${x.rank}</td></tr>`;});
  document.getElementById('tResTable').innerHTML=h;
}
function tGetText(){
  const d=tScores.map((s,i)=>({cls:i+1,s,total:CRITERIA.reduce((sum,c)=>sum+s[c.key],0)}));
  const sorted=[...d].sort((a,b)=>b.total-a.total);let r=1;sorted.forEach((it,i)=>{if(i>0&&it.total<sorted[i-1].total)r=i+1;it.rank=r;});
  sorted.forEach(x=>d[x.cls-1].rank=x.rank);
  let t=`ğŸ“‹ 114å­¸å¹´åº¦è¦ªè·æ•™è‚²æ—¥\nåœ’éŠæœƒæ”¤ä½è©•åˆ†çµæœ\nâ”â”â”â”â”â”â”â”â”â”\nè©•åˆ†è€å¸«ï¼š${tTeacher}\nè©•åˆ†å¹´ç´šï¼š${tGrade}\nâ”â”â”â”â”â”â”â”â”â”\nç­ç´š | `;
  CRITERIA.forEach(c=>t+=`${c.name} | `);t+=`ç¸½åˆ† | åæ¬¡\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  d.forEach(x=>{t+=`${x.cls}ç­ | `;CRITERIA.forEach(c=>t+=`${x.s[c.key]} | `);t+=`${x.total} | ç¬¬${x.rank}å\n`;});
  t+=`â”â”â”â”â”â”â”â”â”â”\n`;const now=new Date(),p=n=>String(n).padStart(2,'0');
  t+=`è©•åˆ†æ™‚é–“ï¼š${now.getFullYear()}/${p(now.getMonth()+1)}/${p(now.getDate())} ${p(now.getHours())}:${p(now.getMinutes())}`;return t;
}
function tCopyRes(){doCopy(tGetText());}
function shareLine(text){const t=encodeURIComponent(text);const isM=/iPhone|iPad|Android/i.test(navigator.userAgent);if(isM){window.location.href='line://msg/text/'+t;}else{window.open('https://social-plugins.line.me/lineit/share?url=&text='+t,'_blank');}}

// ===== ç®¡ç†è€… =====
function initAdmin(){
  aCurGrade=GRADES[0];aCurTeacher=0;
  const bar=document.getElementById('aGradeBar');bar.innerHTML='';
  GRADES.forEach(g=>{const b=document.createElement('button');b.className='ag-btn'+(g===aCurGrade?' on':'');b.textContent=g;b.onclick=()=>{aCurGrade=g;aCurTeacher=0;aRefresh();};bar.appendChild(b);});
  aRefresh();
}
function aRefresh(){
  document.querySelectorAll('.ag-btn').forEach(b=>b.classList.toggle('on',b.textContent===aCurGrade));
  document.getElementById('aCntVal').textContent=aClassCounts[aCurGrade];
  aEnsure();aRenderTT();aRenderInput();aRenderStats();
}
function aEnsure(){
  const g=aCurGrade,cnt=aClassCounts[g];
  TEACHERS[g].forEach(t=>{
    if(!aData[g][t]||aData[g][t].length!==cnt){
      const old=aData[g][t]||[];aData[g][t]=[];
      for(let i=0;i<cnt;i++){if(old[i])aData[g][t].push({...old[i]});else{const o={};CRITERIA.forEach(c=>o[c.key]=0);aData[g][t].push(o);}}
    }
  });
}
function aAdjCount(d){aClassCounts[aCurGrade]=Math.max(1,Math.min(15,aClassCounts[aCurGrade]+d));aEnsure();aRefresh();saveLS();}
function aRenderTT(){
  const w=document.getElementById('aTeacherTabs');w.innerHTML='';
  TEACHERS[aCurGrade].forEach((t,i)=>{
    const btn=document.createElement('button');btn.className='tt'+(i===aCurTeacher?' on':'');btn.textContent=t;
    if(aTDone(t)&&i!==aCurTeacher)btn.classList.add('done');
    btn.onclick=()=>{aCurTeacher=i;aRenderTT();aRenderInput();};w.appendChild(btn);
  });
}
function aTDone(t){const a=aData[aCurGrade][t];return a&&a.every(cls=>CRITERIA.every(c=>cls[c.key]>0));}
function aRenderInput(){
  const teacher=TEACHERS[aCurGrade][aCurTeacher],cnt=aClassCounts[aCurGrade],scores=aData[aCurGrade][teacher];
  const ts=aTimestamps[aCurGrade]&&aTimestamps[aCurGrade][teacher];
  let h=`<div class="score-card"><h3>${teacher}çš„è©•åˆ†</h3>${ts?`<div class="submit-time">ğŸ“Œ æäº¤æ™‚é–“ï¼š${ts}</div>`:''}<table class="input-table"><tr><th>ç­ç´š</th>`;
  CRITERIA.forEach(c=>h+=`<th>${c.name}</th>`);h+=`<th>ç¸½åˆ†</th></tr>`;
  for(let i=0;i<cnt;i++){
    const s=scores[i],total=CRITERIA.reduce((sum,c)=>sum+(s[c.key]||0),0);
    h+=`<tr><td class="cls-label">${i+1}ç­</td>`;
    CRITERIA.forEach(c=>{const v=s[c.key]||'';h+=`<td><input type="number" class="score-input${v?' filled':''}" min="0" max="${MAX}" value="${v||''}" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()" oninput="aSet('${teacher}',${i},'${c.key}',this)" onchange="aSet('${teacher}',${i},'${c.key}',this)"></td>`;});
    h+=`<td class="row-total-admin">${total||'-'}</td></tr>`;
  }
  h+=`</table></div>`;document.getElementById('aInputArea').innerHTML=h;
}
function aSet(teacher,ci,key,el){
  let v=parseInt(el.value);if(isNaN(v)||v<0)v=0;if(v>MAX){v=MAX;el.value=v;}
  aData[aCurGrade][teacher][ci][key]=v;el.classList.toggle('filled',v>0);
  const s=aData[aCurGrade][teacher][ci];el.closest('tr').querySelector('.row-total-admin').textContent=CRITERIA.reduce((sum,c)=>sum+(s[c.key]||0),0)||'-';
  aRenderTT();aRenderStats();saveLS();
}
function aRenderStats(){
  const sec=document.getElementById('aStatsSection'),g=aCurGrade,cnt=aClassCounts[g],ts=TEACHERS[g];
  let any=false;ts.forEach(t=>{if(aData[g][t])aData[g][t].forEach(cls=>{if(CRITERIA.some(c=>cls[c.key]>0))any=true;});});
  if(!any){sec.style.display='none';return;}sec.style.display='block';
  const res=[];
  for(let i=0;i<cnt;i++){const tt=[];ts.forEach(t=>{const s=aData[g][t][i];tt.push(CRITERIA.reduce((sum,c)=>sum+(s[c.key]||0),0));});const avg=tt.reduce((a,b)=>a+b,0)/ts.length;res.push({cls:i+1,tt,avg});}
  const sorted=[...res].sort((a,b)=>b.avg-a.avg);let rk=1;sorted.forEach((it,i)=>{if(i>0&&it.avg<sorted[i-1].avg)rk=i+1;it.rank=rk;});
  sorted.forEach(s=>res[s.cls-1].rank=s.rank);
  let h=`<tr><th>ç­ç´š</th>`;ts.forEach(t=>h+=`<th>${t.replace('è€å¸«','').replace('ä¸»ä»»','')}</th>`);h+=`<th>å¹³å‡</th><th>åæ¬¡</th></tr>`;
  res.forEach(r=>{const rc=r.rank<=3?` rank-${r.rank}`:'';h+=`<tr><td><strong>${r.cls}ç­</strong></td>`;r.tt.forEach(t=>h+=`<td>${t||'-'}</td>`);h+=`<td class="highlight">${r.avg.toFixed(1)}</td><td class="${rc}">${r.rank}</td></tr>`;});
  document.getElementById('aStatsTable').innerHTML=h;
}
function aGetText(grade){
  const g=grade||aCurGrade,cnt=aClassCounts[g],ts=TEACHERS[g];
  const res=[];for(let i=0;i<cnt;i++){const tt=[];ts.forEach(t=>{const s=aData[g][t][i];tt.push(CRITERIA.reduce((sum,c)=>sum+(s[c.key]||0),0));});res.push({cls:i+1,tt,avg:tt.reduce((a,b)=>a+b,0)/ts.length});}
  const sorted=[...res].sort((a,b)=>b.avg-a.avg);let rk=1;sorted.forEach((it,i)=>{if(i>0&&it.avg<sorted[i-1].avg)rk=i+1;it.rank=rk;});
  sorted.forEach(s=>res[s.cls-1].rank=s.rank);
  let t=`ğŸ“Š 114å­¸å¹´åº¦è¦ªè·æ•™è‚²æ—¥\n${g} è©•åˆ†çµ±è¨ˆ\nâ”â”â”â”â”â”â”â”â”â”\nç­ç´š | `;ts.forEach(tc=>t+=`${tc.replace('è€å¸«','').replace('ä¸»ä»»','')} | `);t+=`å¹³å‡ | åæ¬¡\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  res.forEach(r=>{t+=`${r.cls}ç­ | `;r.tt.forEach(v=>t+=`${v} | `);t+=`${r.avg.toFixed(1)} | ç¬¬${r.rank}å\n`;});
  t+=`â”â”â”â”â”â”â”â”â”â”\n`;const now=new Date(),p=n=>String(n).padStart(2,'0');
  t+=`çµ±è¨ˆæ™‚é–“ï¼š${now.getFullYear()}/${p(now.getMonth()+1)}/${p(now.getDate())} ${p(now.getHours())}:${p(now.getMinutes())}\n`;return t;
}
function aCopyStats(){doCopy(aGetText());}
function shareLine(text){const t=encodeURIComponent(text);const isM=/iPhone|iPad|Android/i.test(navigator.userAgent);if(isM){window.location.href='line://msg/text/'+t;}else{window.open('https://social-plugins.line.me/lineit/share?url=&text='+t,'_blank');}}
function aExportAll(){
  let all=`ğŸ“Š 114å­¸å¹´åº¦è¦ªè·æ•™è‚²æ—¥ å…¨å¹´ç´šçµ±è¨ˆ\n\n`;
  GRADES.forEach(g=>{let has=false;TEACHERS[g].forEach(t=>{if(aData[g][t])aData[g][t].forEach(cls=>{if(CRITERIA.some(c=>cls[c.key]>0))has=true;});});if(has)all+=aGetText(g)+'\n';});
  doCopy(all);
}

// ===== localStorage =====
function saveLS(){try{localStorage.setItem('pd_data',JSON.stringify(aData));localStorage.setItem('pd_counts',JSON.stringify(aClassCounts));localStorage.setItem('pd_timestamps',JSON.stringify(aTimestamps));}catch(e){}}
function loadLS(){try{const d=localStorage.getItem('pd_data'),c=localStorage.getItem('pd_counts'),ts=localStorage.getItem('pd_timestamps');if(d){const p=JSON.parse(d);GRADES.forEach(g=>{if(p[g])TEACHERS[g].forEach(t=>{if(p[g][t])aData[g][t]=p[g][t];});});}if(c){const p=JSON.parse(c);GRADES.forEach(g=>{if(p[g])aClassCounts[g]=p[g];});}if(ts){const p=JSON.parse(ts);GRADES.forEach(g=>{if(p[g])TEACHERS[g].forEach(t=>{if(p[g][t])aTimestamps[g][t]=p[g][t];});});}}catch(e){}}

// ===== å·¥å…· =====
function doCopy(text){if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(text).then(()=>showToast('å·²è¤‡è£½ï¼')).catch(()=>fbCopy(text));else fbCopy(text);}
function fbCopy(text){const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;left:-9999px';document.body.appendChild(ta);ta.select();try{document.execCommand('copy');showToast('å·²è¤‡è£½ï¼');}catch(e){showToast('è¤‡è£½å¤±æ•—');}document.body.removeChild(ta);}
function showToast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800);}

loadLS();
</script>
</body>
</html>
